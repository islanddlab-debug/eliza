<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eliza's English Playground</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- Ê†∏ÂøÉËÆäÊï∏ --- */
        :root {
            --primary: #FF9F1C;
            --secondary: #2EC4B6;
            --accent: #FFBF69;
            --phonics: #FF99C8;
            --bg: #F4F7F6;
            --card-bg: #FFFFFF;
            --text-main: #2D3436;
            --side-gap: 20px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Fredoka', 'Microsoft JhengHei', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 80px; 
            color: var(--text-main);
            overflow-x: hidden;
            font-size: 18px; /* ÂÖ®Â±ÄÂ≠óÈ´îÂÜçÁ®çÂæÆÂä†Â§ß‰∏ÄÈªûÈªû */
        }
        
        /* --- Header --- */
        .header-area {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            width: 100%;
        }

        .header-inner {
            max-width: 1200px; margin: 0 auto;
            padding: 10px var(--side-gap) 0 var(--side-gap);
        }

        .top-row {
            display: flex; justify-content: space-between; align-items: center;
            gap: 15px; margin-bottom: 10px;
        }
        
        h1 { 
            margin: 0; color: var(--primary); 
            font-size: 1.8rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; 
            white-space: nowrap; letter-spacing: 0.5px;
        }

        .search-box { flex-grow: 1; position: relative; max-width: 400px; }
        .search-input {
            width: 100%; padding: 12px 18px; border-radius: 25px;
            border: 2px solid #eee; font-size: 1rem; outline: none;
            transition: 0.3s; background: #f9f9f9; appearance: none;
            font-family: 'Fredoka', sans-serif;
        }
        .search-input:focus { border-color: var(--secondary); background: white; }

        .tools-row {
            display: flex; gap: 10px; overflow-x: auto; align-items: center;
            padding-bottom: 10px; scrollbar-width: none;
        }
        .tools-row::-webkit-scrollbar { display: none; }

        .tool-btn {
            background: #fff; border: 2px solid #eee; color: #555;
            padding: 10px 18px; border-radius: 25px; cursor: pointer;
            font-size: 0.95rem; display: flex; align-items: center; gap: 6px;
            white-space: nowrap; font-weight: 600; transition: 0.2s; flex-shrink: 0;
            font-family: 'Fredoka', sans-serif;
        }
        .tool-btn:active { transform: scale(0.95); background: #f0f0f0; }
        
        #btnMode { background: #E3F2FD; color: #1565C0; border-color: #BBDEFB; }
        .btn-quiz { background: var(--primary); color: white; border: none; }

        .nav-scroller { 
            overflow-x: auto; white-space: nowrap; 
            padding: 5px var(--side-gap) 15px var(--side-gap);
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
            margin-left: calc(var(--side-gap) * -1); margin-right: calc(var(--side-gap) * -1);
            padding-left: var(--side-gap);
        }
        .nav-scroller::-webkit-scrollbar { display: none; }
        
        .room-tab {
            display: inline-block; padding: 10px 20px; margin-right: 8px;
            background: white; border-radius: 25px; cursor: pointer;
            border: 2px solid #eee; color: #666; font-weight: 600; font-size: 1rem;
            transition: all 0.2s; font-family: 'Fredoka', sans-serif;
        }
        .room-tab.active { background: var(--secondary); color: white; border-color: var(--secondary); transform: scale(1.05); }
        .room-tab.phonics-tab { border-color: var(--phonics); color: var(--phonics); }
        .room-tab.phonics-tab.active { background: var(--phonics); color: white; border-color: var(--phonics); }

        /* --- Content --- */
        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 var(--side-gap); }

        #quizArea {
            display: none; background: var(--accent); padding: 15px;
            text-align: center; margin: 15px 0; border-radius: 15px;
            box-shadow: 0 4px 0 #e5ac5e; animation: bounceIn 0.5s;
        }
        @keyframes bounceIn { 0% {transform: scale(0.8); opacity:0;} 70% {transform: scale(1.05);} 100% {transform: scale(1); opacity:1;} }
        #quizQuestion { font-size: 1.5rem; font-weight: 600; color: #444; }

        /* --- Grid ÂÑ™ÂåñÔºöÈáùÂ∞ç iPad/ÈõªËÖ¶ ÊîæÂ§ßÂç°Áâá --- */
        .grid {
            display: grid; 
            /* ÈÄôË£°ÊîπÊàê 180pxÔºåËÆìÂ§ßËû¢ÂπïÁöÑÂç°ÁâáËÆäÂØ¨ÔºåÂ≠óÊâçÂ°ûÂæó‰∏ã */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 20px; padding-bottom: 40px;
        }
        
        /* ÊâãÊ©üÁâà (Â∞èËû¢Âπï) ‰øùÊåÅ‰∏ÄÊéíÂÖ©ÂÄã */
        @media (max-width: 480px) {
            .grid { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 12px; 
            }
            .top-row { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; }
            h1 { justify-content: center; font-size: 1.6rem; margin-bottom: 5px; }
        }

        /* --- Card Styles --- */
        .card {
            background: var(--card-bg); border-radius: 20px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            transition: transform 0.2s; border: 3px solid transparent;
            position: relative; overflow: hidden; user-select: none;
            aspect-ratio: 1 / 1.15; display: flex; flex-direction: column;
        }
        .card:active { transform: scale(0.98); }
        
        .rule-tag {
            font-size: 0.85rem; font-weight: 600; padding: 5px 0;
            color: #fff; background: rgba(0,0,0,0.1); width: 100%;
            letter-spacing: 1px;
        }

        .card-img {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            font-size: 4.5rem; /* Emoji ÊîæÂ§ß */
            background: linear-gradient(180deg, #fafafa 0%, #fff 100%);
            width: 100%; transition: background 0.3s;
        }
        .card-body { padding: 12px 5px; border-top: 1px solid rgba(0,0,0,0.05); background: #fff; }
        
        .en-word { font-size: 1.4rem; font-weight: 600; color: #333; display: block; margin-bottom: 2px; transition: opacity 0.3s; }
        .zh-word { font-size: 1.1rem; color: #888; font-weight: 500; transition: opacity 0.3s; font-family: 'Microsoft JhengHei', sans-serif; }

        .phonics-card .en-word { font-size: 1.6rem; color: #333; } 
        .flag-card .card-img img { width: 100%; height: 100%; object-fit: cover; }
        
        .hide-zh .zh-word { opacity: 0; }
        .hide-en .en-word { opacity: 0; }
        
        .card.correct { border-color: #4CAF50; transform: scale(1.05) !important; z-index: 10; box-shadow: 0 0 15px #4CAF50; }
        .card.wrong { border-color: #F44336; opacity: 0.6; animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        /* --- Focus Mode & Modal --- */
        #focusOverlay, .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(244, 247, 246, 0.95); z-index: 500; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .modal-overlay { background: rgba(0,0,0,0.85); z-index: 999; }

        .focus-card {
            background: white; width: 85%; max-width: 400px; aspect-ratio: 3/4;
            border-radius: 35px; box-shadow: 0 15px 50px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; border: 8px solid white; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .focus-card-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.1; }
        .focus-content-layer { z-index: 1; text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; }

        .focus-rule { font-size: 1.6rem; color: #888; margin-bottom: 10px; font-weight: bold; letter-spacing: 2px; }
        .focus-icon { font-size: 8rem; margin-bottom: 15px; }
        .focus-en { font-size: 3.2rem; font-weight: 600; color: var(--text-main); margin-bottom: 5px; line-height: 1.1; transition: opacity 0.3s; }
        .focus-zh { font-size: 1.6rem; color: #666; margin-bottom: 20px; transition: opacity 0.3s; }
        .focus-flag-img { width: 90%; height: auto; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .focus-mic-container {
            position: relative; width: 70px; height: 70px;
            display: flex; align-items: center; justify-content: center;
            margin-top: 10px;
        }
        .focus-mic-btn {
            width: 56px; height: 56px; border-radius: 50%;
            background: white; border: 2px solid #f0f0f0; color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 1.8rem; cursor: pointer; z-index: 2;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .focus-mic-btn:active { transform: scale(0.95); background: #f9f9f9; }

        .focus-progress-ring {
            position: absolute; top: 0; left: 0;
            width: 70px; height: 70px; transform: rotate(-90deg);
            z-index: 1; pointer-events: none;
        }
        .focus-progress-ring__circle {
            stroke-dasharray: 201; stroke-dashoffset: 201; transition: stroke-dashoffset 0s;
        }
        
        .recording .focus-mic-btn { background: #FF5252; color: white; border-color: #FF5252; animation: pulse-red 1s infinite; }
        .recording .focus-progress-ring__circle { stroke-dashoffset: 0; transition: stroke-dashoffset 2s linear; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .focus-nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 1.5rem; color: var(--secondary); cursor: pointer; z-index: 501;
        }
        .prev-btn { left: 15px; } .next-btn { right: 15px; }
        @media (max-width: 480px) {
            .focus-nav-btn { top: 88%; background: rgba(255,255,255,0.9); }
            .prev-btn { left: 15%; } .next-btn { right: 15%; }
        }
        .close-circle-btn {
            position: absolute; top: 20px; right: 20px;
            width: 40px; height: 40px; border-radius: 50%; background: #eee;
            border: none; font-weight: bold; cursor: pointer; color: #555; z-index: 502;
        }

        /* Modal */
        .modal-content {
            background: white; padding: 20px; border-radius: 25px;
            text-align: center; width: 90%; max-width: 500px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4); animation: popIn 0.3s ease;
        }
        @keyframes popIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .modal-img-container {
            width: 100%; height: 300px; background: #f0f0f0;
            border-radius: 15px; margin-bottom: 15px; overflow: hidden;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .modal-img { width: 100%; height: 100%; object-fit: contain; display: none; background: #fff; }
        .modal-loading { font-size: 1.1rem; color: #888; font-weight: bold; }
        .modal-word { font-size: 2rem; color: var(--primary); font-weight: 800; display: block; margin-bottom: 5px; }
        .modal-zh { font-size: 1.2rem; color: #666; margin-bottom: 15px; display: block; }
        
        .source-tag { position: absolute; bottom: 8px; right: 8px; font-size: 0.7rem; background: rgba(0,0,0,0.6); color: white; padding: 3px 8px; border-radius: 6px; }
        .btn-full { width: 100%; padding: 12px; border-radius: 30px; font-weight: bold; margin-top: 10px; cursor: pointer; border: none; font-family: 'Fredoka', sans-serif; }
        .btn-gray { background: #f0f0f0; color: #555; }
        .btn-primary { background: var(--primary); color: white; }

        .count-badge { font-size: 0.7rem; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="modal-overlay" id="imgModal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-img-container">
            <div class="modal-loading" id="modalLoader">üì° ÊêúÂ∞ã‰∏≠...</div>
            <img src="" alt="Learning Image" class="modal-img" id="realImage" onerror="handleFallback()">
            <span class="source-tag" id="imgSource">Wiki</span>
        </div>
        <span class="modal-word" id="modalEn">Word</span>
        <span class="modal-zh" id="modalZh">‰∏≠Êñá</span>
        <button class="btn-full btn-gray" onclick="forceRandomReload()">üîÑ ÂúñÁâá‰∏çÊ∫ñÔºüÊèõ‰∏ÄÂºµ</button>
        <button class="btn-full btn-primary" onclick="closeModal()">ÈóúÈñâ</button>
    </div>
</div>

<div id="focusOverlay">
    <button class="close-circle-btn" onclick="toggleFocusMode()">‚úï</button>
    <button class="focus-nav-btn prev-btn" onclick="focusNav(-1)">‚ùÆ</button>
    <button class="focus-nav-btn next-btn" onclick="focusNav(1)">‚ùØ</button>
    <div class="focus-card" id="focusCard" onclick="handleFocusClick()">
        <div class="focus-card-bg" id="focusBg"></div>
        <div class="focus-content-layer">
            <div class="focus-rule" id="focusRule"></div>
            <div id="focusContent"></div> 
            
            <div class="focus-mic-container" id="focusMicContainer">
                <svg class="focus-progress-ring" width="70" height="70">
                   <circle class="focus-progress-ring__circle" stroke="#FF5252" stroke-width="4" fill="transparent" r="32" cx="35" cy="35"/>
                </svg>
                <button class="focus-mic-btn" onclick="toggleRecord(event, this)">üé§</button>
            </div>
        </div>
    </div>
</div>

<div class="header-area">
    <div class="header-inner">
        <div class="top-row">
            <h1>ü¶Å Eliza's English Playground</h1>
            <div class="search-box">
                <input type="search" class="search-input" id="searchInput" placeholder="üîç ÊêúÂ∞ãÂñÆÂ≠ó..." oninput="handleSearch()">
            </div>
        </div>
        
        <div class="tools-row">
            <button class="tool-btn btn-quiz" onclick="toggleQuiz()">üéÆ Ê∏¨È©ó</button>
            <button class="tool-btn" id="btnMode" onclick="cycleMode()">üìñ È°ØÁ§∫Ôºö‰∏≠+Ëã±</button>
            <button class="tool-btn" id="btnFocus" onclick="toggleFocusMode()">üî≤ Â∞àÊ≥®Ê®°Âºè</button>
        </div>

        <div class="nav-scroller" id="navBar"></div>
    </div>
</div>

<div class="main-container">
    <div id="quizArea">
        <div id="quizQuestion">üîä ËÅΩËÅ≤Èü≥ÊâæÊâæÁúãÔºÅ</div>
    </div>
    <div class="grid" id="cardGrid"></div>
</div>

<script>
    // =========================================================
    //  1. Ë©ûÂ∫´
    // =========================================================
    const db = {
        "üî§ Â≠óÊØç A-Z": [
            { rule: "A", en: "Apple", zh: "ËòãÊûú", icon: "üçé", speak: "A, Apple" },
            { rule: "A", en: "Ant", zh: "ËûûËüª", icon: "üêú", speak: "A, Ant" },
            { rule: "B", en: "Bear", zh: "ÁÜä", icon: "üêª", speak: "B, Bear" },
            { rule: "B", en: "Ball", zh: "ÁêÉ", icon: "‚öΩ", speak: "B, Ball" },
            { rule: "C", en: "Cat", zh: "Ë≤ì", icon: "üê±", speak: "C, Cat" },
            { rule: "C", en: "Car", zh: "Ëªä", icon: "üöó", speak: "C, Car" },
            { rule: "D", en: "Dog", zh: "Áãó", icon: "üê∂", speak: "D, Dog" },
            { rule: "E", en: "Elephant", zh: "Â§ßË±°", icon: "üêò", speak: "E, Elephant" },
            { rule: "E", en: "Egg", zh: "Ëõã", icon: "ü•ö", speak: "E, Egg" },
            { rule: "F", en: "Frog", zh: "ÈùíËõô", icon: "üê∏", speak: "F, Frog" },
            { rule: "F", en: "Fish", zh: "È≠ö", icon: "üêü", speak: "F, Fish" },
            { rule: "G", en: "Goat", zh: "Â±±Áæä", icon: "üêê", speak: "G, Goat" },
            { rule: "H", en: "Hat", zh: "Â∏ΩÂ≠ê", icon: "üëí", speak: "H, Hat" },
            { rule: "I", en: "Igloo", zh: "ÂÜ∞Â±ã", icon: "üõñ", speak: "I, Igloo" },
            { rule: "J", en: "Jet", zh: "Âô¥Â∞ÑÊ©ü", icon: "‚úàÔ∏è", speak: "J, Jet" },
            { rule: "K", en: "Kite", zh: "È¢®ÁÆè", icon: "ü™Å", speak: "K, Kite" },
            { rule: "L", en: "Lion", zh: "ÁçÖÂ≠ê", icon: "ü¶Å", speak: "L, Lion" },
            { rule: "M", en: "Monkey", zh: "Áå¥Â≠ê", icon: "üêí", speak: "M, Monkey" },
            { rule: "N", en: "Nest", zh: "È≥•Â∑¢", icon: "ü™∫", speak: "N, Nest" },
            { rule: "O", en: "Octopus", zh: "Á´†È≠ö", icon: "üêô", speak: "O, Octopus" },
            { rule: "P", en: "Pig", zh: "Ë±¨", icon: "üê∑", speak: "P, Pig" },
            { rule: "Q", en: "Queen", zh: "Â•≥Áéã", icon: "üë∏", speak: "Q, Queen" },
            { rule: "R", en: "Rabbit", zh: "ÂÖîÂ≠ê", icon: "üê∞", speak: "R, Rabbit" },
            { rule: "S", en: "Sun", zh: "Â§™ÈôΩ", icon: "‚òÄÔ∏è", speak: "S, Sun" },
            { rule: "T", en: "Tiger", zh: "ËÄÅËôé", icon: "üêØ", speak: "T, Tiger" },
            { rule: "U", en: "Umbrella", zh: "Èõ®ÂÇò", icon: "‚òî", speak: "U, Umbrella" },
            { rule: "V", en: "Van", zh: "ÂªÇÂûãËªä", icon: "üöê", speak: "V, Van" },
            { rule: "W", en: "Wolf", zh: "Áãº", icon: "üê∫", speak: "W, Wolf" },
            { rule: "X", en: "Box", zh: "ÁÆ±Â≠ê", icon: "üì¶", speak: "X, Box" },
            { rule: "Y", en: "Yo-yo", zh: "Ê∫úÊ∫úÁêÉ", icon: "ü™Ä", speak: "Y, Yo-yo" },
            { rule: "Z", en: "Zebra", zh: "ÊñëÈ¶¨", icon: "ü¶ì", speak: "Z, Zebra" }
        ],
        "üî§ Áü≠ÊØçÈü≥ Short Vowels": [
            { rule: "Short a", en: "Cat", zh: "Ë≤ì", icon: "üê±", speak: "Short a, Cat" },
            { rule: "Short a", en: "Hat", zh: "Â∏ΩÂ≠ê", icon: "üëí", speak: "Short a, Hat" },
            { rule: "Short a", en: "Map", zh: "Âú∞Âúñ", icon: "üó∫Ô∏è", speak: "Short a, Map" },
            { rule: "Short a", en: "Dad", zh: "Áà∏Áà∏", icon: "üë®", speak: "Short a, Dad" },
            { rule: "Short e", en: "Hen", zh: "ÊØçÈõû", icon: "üêî", speak: "Short e, Hen" },
            { rule: "Short e", en: "Pen", zh: "Á≠Ü", icon: "üñäÔ∏è", speak: "Short e, Pen" },
            { rule: "Short e", en: "Bed", zh: "Â∫ä", icon: "üõèÔ∏è", speak: "Short e, Bed" },
            { rule: "Short i", en: "Pig", zh: "Ë±¨", icon: "üê∑", speak: "Short i, Pig" },
            { rule: "Short i", en: "Wig", zh: "ÂÅáÈ´Æ", icon: "ü¶≥", speak: "Short i, Wig" },
            { rule: "Short i", en: "Bin", zh: "Ê°∂Â≠ê", icon: "üóëÔ∏è", speak: "Short i, Bin" },
            { rule: "Short o", en: "Dog", zh: "Áãó", icon: "üê∂", speak: "Short o, Dog" },
            { rule: "Short o", en: "Fox", zh: "ÁãêÁã∏", icon: "ü¶ä", speak: "Short o, Fox" },
            { rule: "Short o", en: "Box", zh: "ÁÆ±Â≠ê", icon: "üì¶", speak: "Short o, Box" },
            { rule: "Short u", en: "Bus", zh: "ÂÖ¨Ëªä", icon: "üöå", speak: "Short u, Bus" },
            { rule: "Short u", en: "Bug", zh: "Ëü≤", icon: "ü™≤", speak: "Short u, Bug" },
            { rule: "Short u", en: "Cup", zh: "ÊùØÂ≠ê", icon: "‚òï", speak: "Short u, Cup" }
        ],
        "üî§ Èï∑ÊØçÈü≥ Long Vowels": [
            { rule: "a_e", en: "Cake", zh: "ËõãÁ≥ï", icon: "üéÇ", speak: "Long a, Cake" },
            { rule: "a_e", en: "Snake", zh: "Ëõá", icon: "üêç", speak: "Long a, Snake" },
            { rule: "a_e", en: "Grape", zh: "Ëë°ËêÑ", icon: "üçá", speak: "Long a, Grape" },
            { rule: "ee", en: "Tree", zh: "Ê®π", icon: "üå≥", speak: "Long e, Tree" },
            { rule: "ee", en: "Bee", zh: "ËúúËúÇ", icon: "üêù", speak: "Long e, Bee" },
            { rule: "ee", en: "Sheep", zh: "Á∂øÁæä", icon: "üêë", speak: "Long e, Sheep" },
            { rule: "i_e", en: "Kite", zh: "È¢®ÁÆè", icon: "ü™Å", speak: "Long i, Kite" },
            { rule: "i_e", en: "Bike", zh: "ËÖ≥Ë∏èËªä", icon: "üö≤", speak: "Long i, Bike" },
            { rule: "i_e", en: "Five", zh: "‰∫î", icon: "5Ô∏è‚É£", speak: "Long i, Five" },
            { rule: "o_e", en: "Bone", zh: "È™®È†≠", icon: "ü¶¥", speak: "Long o, Bone" },
            { rule: "o_e", en: "Rose", zh: "Áé´Áë∞", icon: "üåπ", speak: "Long o, Rose" },
            { rule: "o_e", en: "Phone", zh: "ÈõªË©±", icon: "üì±", speak: "Long o, Phone" },
            { rule: "u_e", en: "Cube", zh: "ÊñπÂ°ä", icon: "üßä", speak: "Long u, Cube" },
            { rule: "u_e", en: "Cute", zh: "ÂèØÊÑõ", icon: "ü•∫", speak: "Long u, Cute" }
        ],
        "üî§ ÈõôÂ≠óÊØç/Ê∑∑ÂêàÈü≥": [
            { rule: "sh", en: "Ship", zh: "Ëàπ", icon: "üö¢", speak: "S-H, Ship" },
            { rule: "sh", en: "Fish", zh: "È≠ö", icon: "üêü", speak: "S-H, Fish" },
            { rule: "ch", en: "Chair", zh: "Ê§ÖÂ≠ê", icon: "ü™ë", speak: "C-H, Chair" },
            { rule: "ch", en: "Cheese", zh: "Ëµ∑Âè∏", icon: "üßÄ", speak: "C-H, Cheese" },
            { rule: "th", en: "Thumb", zh: "Â§ßÊãáÊåá", icon: "üëç", speak: "T-H, Thumb" },
            { rule: "wh", en: "Whale", zh: "ÈØ®È≠ö", icon: "üêã", speak: "W-H, Whale" },
            { rule: "bl", en: "Blue", zh: "ËóçËâ≤", icon: "üîµ", speak: "b-l, Blue" },
            { rule: "fl", en: "Flower", zh: "Ëä±", icon: "üåª", speak: "f-l, Flower" },
            { rule: "st", en: "Star", zh: "ÊòüÊòü", icon: "‚≠ê", speak: "s-t, Star" }
        ],
        "ü¶Å ÈáéÁîüÂãïÁâ© Wild": [
            { en: "Lion", zh: "ÁçÖÂ≠ê", icon: "ü¶Å" },
            { en: "Tiger", zh: "ËÄÅËôé", icon: "üêØ" },
            { en: "Elephant", zh: "Â§ßË±°", icon: "üêò" },
            { en: "Monkey", zh: "Áå¥Â≠ê", icon: "üêí" },
            { en: "Gorilla", zh: "Â§ßÁå©Áå©", icon: "ü¶ç" },
            { en: "Zebra", zh: "ÊñëÈ¶¨", icon: "ü¶ì" },
            { en: "Giraffe", zh: "Èï∑È†∏Èπø", icon: "ü¶í" },
            { en: "Bear", zh: "ÁÜä", icon: "üêª" },
            { en: "Panda", zh: "ÁÜäË≤ì", icon: "üêº" },
            { en: "Kangaroo", zh: "Ë¢ãÈº†", icon: "ü¶ò" },
            { en: "Koala", zh: "ÁÑ°Â∞æÁÜä", icon: "üê®" },
            { en: "Crocodile", zh: "È±∑È≠ö", icon: "üêä" },
            { en: "Hippo", zh: "Ê≤≥È¶¨", icon: "ü¶õ" },
            { en: "Rhino", zh: "ÁäÄÁâõ", icon: "ü¶è" },
            { en: "Camel", zh: "Èß±Èßù", icon: "üê´" },
            { en: "Sloth", zh: "Ê®πÊá∂", icon: "ü¶•" }
        ],
        "üê∑ Ëæ≤Â†¥ÂãïÁâ© Farm": [
            { en: "Dog", zh: "Áãó", icon: "üê∂" },
            { en: "Cat", zh: "Ë≤ì", icon: "üê±" },
            { en: "Pig", zh: "Ë±¨", icon: "üê∑" },
            { en: "Cow", zh: "Áâõ", icon: "üêÑ" },
            { en: "Sheep", zh: "Á∂øÁæä", icon: "üêë" },
            { en: "Goat", zh: "Â±±Áæä", icon: "üêê" },
            { en: "Horse", zh: "È¶¨", icon: "üêé" },
            { en: "Chicken", zh: "Èõû", icon: "üêî" },
            { en: "Rooster", zh: "ÂÖ¨Èõû", icon: "üêì" },
            { en: "Duck", zh: "È¥®Â≠ê", icon: "ü¶Ü" },
            { en: "Rabbit", zh: "ÂÖîÂ≠ê", icon: "üê∞" },
            { en: "Mouse", zh: "ËÄÅÈº†", icon: "üê≠" }
        ],
        "üê¨ Êµ∑Ê¥ãÁîüÁâ© Ocean": [
            { en: "Whale", zh: "ÈØ®È≠ö", icon: "üêã" },
            { en: "Dolphin", zh: "Êµ∑Ë±ö", icon: "üê¨" },
            { en: "Shark", zh: "ÈØäÈ≠ö", icon: "ü¶à" },
            { en: "Octopus", zh: "Á´†È≠ö", icon: "üêô" },
            { en: "Squid", zh: "ÁÉèË≥ä", icon: "ü¶ë" },
            { en: "Crab", zh: "ËûÉËüπ", icon: "ü¶Ä" },
            { en: "Lobster", zh: "ÈæçËù¶", icon: "ü¶û" },
            { en: "Shrimp", zh: "Ëù¶Â≠ê", icon: "ü¶ê" },
            { en: "Fish", zh: "È≠ö", icon: "üê†" },
            { en: "Turtle", zh: "ÁÉèÈæú", icon: "üê¢" },
            { en: "Penguin", zh: "‰ºÅÈµù", icon: "üêß" },
            { en: "Seal", zh: "Êµ∑Ë±π", icon: "ü¶≠" }
        ],
        "üêû ÊòÜËü≤‰∏ñÁïå Bugs": [
            { en: "Butterfly", zh: "Ëù¥Ëù∂", icon: "ü¶ã" },
            { en: "Bee", zh: "ËúúËúÇ", icon: "üêù" },
            { en: "Ant", zh: "ËûûËüª", icon: "üêú" },
            { en: "Ladybug", zh: "Áì¢Ëü≤", icon: "üêû" },
            { en: "Spider", zh: "ËúòËõõ", icon: "üï∑Ô∏è" },
            { en: "Caterpillar", zh: "ÊØõÊØõËü≤", icon: "üêõ" },
            { en: "Snail", zh: "Ëù∏Áâõ", icon: "üêå" },
            { en: "Mosquito", zh: "ËöäÂ≠ê", icon: "ü¶ü" },
            { en: "Beetle", zh: "Áî≤Ëü≤", icon: "ü™≤" },
            { en: "Scorpion", zh: "Ë†çÂ≠ê", icon: "ü¶Ç" }
        ],
        "üçé Ê∞¥Êûú Fruits": [
            { en: "Apple", zh: "ËòãÊûú", icon: "üçé" },
            { en: "Banana", zh: "È¶ôËïâ", icon: "üçå" },
            { en: "Grape", zh: "Ëë°ËêÑ", icon: "üçá" },
            { en: "Watermelon", zh: "Ë•øÁìú", icon: "üçâ" },
            { en: "Strawberry", zh: "ËçâËéì", icon: "üçì" },
            { en: "Cherry", zh: "Ê´ªÊ°É", icon: "üçí" },
            { en: "Peach", zh: "Ê°ÉÂ≠ê", icon: "üçë" },
            { en: "Pineapple", zh: "È≥≥Ê¢®", icon: "üçç" },
            { en: "Mango", zh: "ËäíÊûú", icon: "ü•≠" },
            { en: "Lemon", zh: "Ê™∏Ê™¨", icon: "üçã" },
            { en: "Orange", zh: "Ê©òÂ≠ê", icon: "üçä" },
            { en: "Kiwi", zh: "Â•áÁï∞Êûú", icon: "ü•ù" },
            { en: "Melon", zh: "ÂìàÂØÜÁìú", icon: "üçà" },
            { en: "Pear", zh: "Ê¢®Â≠ê", icon: "üçê" }
        ],
        "ü•¶ Ëî¨Ëèú Vegetables": [
            { en: "Carrot", zh: "Á¥ÖËòøËîî", icon: "ü•ï" },
            { en: "Corn", zh: "ÁéâÁ±≥", icon: "üåΩ" },
            { en: "Broccoli", zh: "Ëä±Ê§∞Ëèú", icon: "ü•¶" },
            { en: "Mushroom", zh: "ËòëËèá", icon: "üçÑ" },
            { en: "Tomato", zh: "Áï™ËåÑ", icon: "üçÖ" },
            { en: "Potato", zh: "È¶¨Èà¥ËñØ", icon: "ü•î" },
            { en: "Onion", zh: "Ê¥ãËî•", icon: "üßÖ" },
            { en: "Garlic", zh: "Â§ßËíú", icon: "üßÑ" },
            { en: "Pepper", zh: "Ëæ£Ê§í", icon: "üå∂Ô∏è" },
            { en: "Cucumber", zh: "Â∞èÈªÉÁìú", icon: "ü•í" },
            { en: "Eggplant", zh: "ËåÑÂ≠ê", icon: "üçÜ" }
        ],
        "üçî ÁæéÈ£ü Food": [
            { en: "Hamburger", zh: "Êº¢Â†°", icon: "üçî" },
            { en: "Fries", zh: "ËñØÊ¢ù", icon: "üçü" },
            { en: "Pizza", zh: "Êä´Ëñ©", icon: "üçï" },
            { en: "Hotdog", zh: "ÁÜ±Áãó", icon: "üå≠" },
            { en: "Sandwich", zh: "‰∏âÊòéÊ≤ª", icon: "ü•™" },
            { en: "Taco", zh: "Â°îÂèØÈ§Ö", icon: "üåÆ" },
            { en: "Rice", zh: "È£Ø", icon: "üçö" },
            { en: "Noodles", zh: "È∫µ", icon: "üçú" },
            { en: "Spaghetti", zh: "Áæ©Â§ßÂà©È∫µ", icon: "üçù" },
            { en: "Sushi", zh: "Â£ΩÂè∏", icon: "üç£" },
            { en: "Bread", zh: "È∫µÂåÖ", icon: "üçû" },
            { en: "Egg", zh: "Ëõã", icon: "üç≥" },
            { en: "Meat", zh: "ËÇâ", icon: "ü•©" },
            { en: "Chicken", zh: "ÈõûËÖø", icon: "üçó" }
        ],
        "üç∞ ÁîúÈªû Sweets": [
            { en: "Ice Cream", zh: "ÂÜ∞Ê∑áÊ∑ã", icon: "üç¶" },
            { en: "Cake", zh: "ËõãÁ≥ï", icon: "üç∞" },
            { en: "Cookie", zh: "È§Ö‰πæ", icon: "üç™" },
            { en: "Donut", zh: "ÁîúÁîúÂúà", icon: "üç©" },
            { en: "Chocolate", zh: "Â∑ßÂÖãÂäõ", icon: "üç´" },
            { en: "Candy", zh: "Á≥ñÊûú", icon: "üç¨" },
            { en: "Lollipop", zh: "Ê£íÊ£íÁ≥ñ", icon: "üç≠" },
            { en: "Popcorn", zh: "ÁàÜÁ±≥Ëä±", icon: "üçø" },
            { en: "Pudding", zh: "Â∏É‰∏Å", icon: "üçÆ" },
            { en: "Honey", zh: "ËúÇËúú", icon: "üçØ" },
            { en: "Milk", zh: "ÁâõÂ•∂", icon: "ü•õ" },
            { en: "Juice", zh: "ÊûúÊ±Å", icon: "üßÉ" }
        ],
        "üëï Ë°£Êúç Clothing": [
            { en: "T-shirt", zh: "TÊÅ§", icon: "üëï" },
            { en: "Jeans", zh: "Áâõ‰ªîË§≤", icon: "üëñ" },
            { en: "Dress", zh: "Ê¥ãË£ù", icon: "üëó" },
            { en: "Coat", zh: "Â§ñÂ•ó", icon: "üß•" },
            { en: "Socks", zh: "Ë•™Â≠ê", icon: "üß¶" },
            { en: "Shoe", zh: "ÈûãÂ≠ê", icon: "üëü" },
            { en: "Hat", zh: "Â∏ΩÂ≠ê", icon: "üß¢" },
            { en: "Scarf", zh: "ÂúçÂ∑æ", icon: "üß£" },
            { en: "Gloves", zh: "ÊâãÂ•ó", icon: "üß§" },
            { en: "Glasses", zh: "ÁúºÈè°", icon: "üëì" },
            { en: "Tie", zh: "È†òÂ∏∂", icon: "üëî" },
            { en: "Bag", zh: "ÂåÖÂåÖ", icon: "üéí" },
            { en: "Umbrella", zh: "Èõ®ÂÇò", icon: "üåÇ" },
            { en: "Ring", zh: "ÊàíÊåá", icon: "üíç" }
        ],
        "üè´ Â≠∏Ê†° School": [
            { en: "Pencil", zh: "ÈâõÁ≠Ü", icon: "‚úèÔ∏è" },
            { en: "Pen", zh: "ÂéüÂ≠êÁ≠Ü", icon: "üñäÔ∏è" },
            { en: "Book", zh: "Êõ∏", icon: "üìñ" },
            { en: "Notebook", zh: "Á≠ÜË®òÊú¨", icon: "üìì" },
            { en: "Ruler", zh: "Â∞∫", icon: "üìè" },
            { en: "Scissors", zh: "Ââ™ÂàÄ", icon: "‚úÇÔ∏è" },
            { en: "Crayon", zh: "Ë†üÁ≠Ü", icon: "üñçÔ∏è" },
            { en: "Backpack", zh: "Êõ∏ÂåÖ", icon: "üéí" },
            { en: "Computer", zh: "ÈõªËÖ¶", icon: "üíª" },
            { en: "Art", zh: "ÁæéË°ì", icon: "üé®" },
            { en: "Music", zh: "Èü≥Ê®Ç", icon: "üéµ" },
            { en: "Bus", zh: "Ê†°Ëªä", icon: "üöå" }
        ],
        "‚öΩ ÈÅãÂãï Sports": [
            { en: "Soccer", zh: "Ë∂≥ÁêÉ", icon: "‚öΩ" },
            { en: "Basketball", zh: "Á±ÉÁêÉ", icon: "üèÄ" },
            { en: "Baseball", zh: "Ê£íÁêÉ", icon: "‚öæ" },
            { en: "Tennis", zh: "Á∂≤ÁêÉ", icon: "üéæ" },
            { en: "Volleyball", zh: "ÊéíÁêÉ", icon: "üèê" },
            { en: "Ping Pong", zh: "Ê°åÁêÉ", icon: "üèì" },
            { en: "Badminton", zh: "ÁæΩÁêÉ", icon: "üè∏" },
            { en: "Bowling", zh: "‰øùÈΩ°ÁêÉ", icon: "üé≥" },
            { en: "Swimming", zh: "Ê∏∏Ê≥≥", icon: "üèä" },
            { en: "Running", zh: "Ë∑ëÊ≠•", icon: "üèÉ" },
            { en: "Cycling", zh: "È®éËªä", icon: "üö¥" },
            { en: "Trophy", zh: "ÁçéÁõÉ", icon: "üèÜ" }
        ],
        "‚õÖ Â§©Ê∞£ Weather": [
            { en: "Sunny", zh: "Êô¥Â§©", icon: "‚òÄÔ∏è" },
            { en: "Cloudy", zh: "Â§öÈõ≤", icon: "‚òÅÔ∏è" },
            { en: "Rainy", zh: "Èõ®Â§©", icon: "üåßÔ∏è" },
            { en: "Snowy", zh: "‰∏ãÈõ™", icon: "üå®Ô∏è" },
            { en: "Windy", zh: "È¢≥È¢®", icon: "üå¨Ô∏è" },
            { en: "Storm", zh: "Êö¥È¢®Èõ®", icon: "‚õàÔ∏è" },
            { en: "Thunder", zh: "ÊâìÈõ∑", icon: "‚ö°" },
            { en: "Rainbow", zh: "ÂΩ©Ëôπ", icon: "üåà" },
            { en: "Star", zh: "ÊòüÊòü", icon: "‚≠ê" },
            { en: "Moon", zh: "Êúà‰∫Æ", icon: "üåô" }
        ],
        "üòä ÊÉÖÁ∑í Feelings": [
            { en: "Happy", zh: "Âø´Ê®Ç", icon: "üòä" },
            { en: "Sad", zh: "Èõ£ÈÅé", icon: "üò¢" },
            { en: "Angry", zh: "ÁîüÊ∞£", icon: "üò†" },
            { en: "Surprised", zh: "È©öË®ù", icon: "üò≤" },
            { en: "Scared", zh: "ÂÆ≥ÊÄï", icon: "üò±" },
            { en: "Sleepy", zh: "ÊÉ≥Áù°", icon: "üò¥" },
            { en: "Sick", zh: "ÁîüÁóÖ", icon: "ü§í" },
            { en: "Cold", zh: "ÂÜ∑", icon: "ü•∂" },
            { en: "Hot", zh: "ÁÜ±", icon: "ü•µ" },
            { en: "Love", zh: "ÊÑõ", icon: "ü•∞" }
        ],
        "üöí ‰∫§ÈÄö Vehicles": [
            { en: "Car", zh: "Ê±ΩËªä", icon: "üöó" },
            { en: "Taxi", zh: "Ë®àÁ®ãËªä", icon: "üöï" },
            { en: "Bus", zh: "ÂÖ¨Ëªä", icon: "üöå" },
            { en: "Police Car", zh: "Ë≠¶Ëªä", icon: "üöì" },
            { en: "Fire Truck", zh: "Ê∂àÈò≤Ëªä", icon: "üöí" },
            { en: "Ambulance", zh: "ÊïëË≠∑Ëªä", icon: "üöë" },
            { en: "Truck", zh: "Âç°Ëªä", icon: "üöö" },
            { en: "Train", zh: "ÁÅ´Ëªä", icon: "üöÇ" },
            { en: "Bullet Train", zh: "È´òÈêµ", icon: "üöÖ" },
            { en: "Bicycle", zh: "ËÖ≥Ë∏èËªä", icon: "üö≤" },
            { en: "Motorcycle", zh: "Ê©üËªä", icon: "üõµ" },
            { en: "Airplane", zh: "È£õÊ©ü", icon: "‚úàÔ∏è" },
            { en: "Helicopter", zh: "Áõ¥ÂçáÊ©ü", icon: "üöÅ" },
            { en: "Rocket", zh: "ÁÅ´ÁÆ≠", icon: "üöÄ" },
            { en: "Boat", zh: "Ëàπ", icon: "üö¢" },
            { en: "Tractor", zh: "ÊãñÊãâÊ©ü", icon: "üöú" }
        ],
        "ü¶ñ ÊÅêÈæç Dinosaurs": [
            { en: "T-Rex", zh: "Êö¥Èæç", icon: "ü¶ñ" },
            { en: "Triceratops", zh: "‰∏âËßíÈæç", icon: "ü¶ï" },
            { en: "Brachiosaurus", zh: "ËÖïÈæç", icon: "ü¶ï" },
            { en: "Stegosaurus", zh: "ÂäçÈæç", icon: "ü¶é" },
            { en: "Pteranodon", zh: "ÁøºÈæç", icon: "ü¶Ö" },
            { en: "Dinosaur Egg", zh: "ÊÅêÈæçËõã", icon: "ü•ö" },
            { en: "Fossil", zh: "ÂåñÁü≥", icon: "ü¶¥" },
            { en: "Volcano", zh: "ÁÅ´Â±±", icon: "üåã" }
        ],
        "üåç ‰∏ñÁïåÂú∞Âúñ World": [
            { en: "Taiwan", zh: "Âè∞ÁÅ£", icon: "üáπüáº", code: "tw" },
            { en: "USA", zh: "ÁæéÂúã", icon: "üá∫üá∏", code: "us" },
            { en: "Japan", zh: "Êó•Êú¨", icon: "üáØüáµ", code: "jp" },
            { en: "China", zh: "‰∏≠Âúã", icon: "üá®üá≥", code: "cn" },
            { en: "UK", zh: "Ëã±Âúã", icon: "üá¨üáß", code: "gb" },
            { en: "France", zh: "Ê≥ïÂúã", icon: "üá´üá∑", code: "fr" },
            { en: "Germany", zh: "Âæ∑Âúã", icon: "üá©üá™", code: "de" },
            { en: "Italy", zh: "Áæ©Â§ßÂà©", icon: "üáÆüáπ", code: "it" },
            { en: "Canada", zh: "Âä†ÊãøÂ§ß", icon: "üá®üá¶", code: "ca" },
            { en: "Australia", zh: "Êæ≥Ê¥≤", icon: "üá¶üá∫", code: "au" },
            { en: "Korea", zh: "ÈüìÂúã", icon: "üá∞üá∑", code: "kr" },
            { en: "World", zh: "‰∏ñÁïå", icon: "üåé" }
        ],
        "üî¢ Êï∏Â≠ó Numbers": [
            { en: "One", zh: "1", speak: "One", icon: "1Ô∏è‚É£" },
            { en: "Two", zh: "2", speak: "Two", icon: "2Ô∏è‚É£" },
            { en: "Three", zh: "3", speak: "Three", icon: "3Ô∏è‚É£" },
            { en: "Four", zh: "4", speak: "Four", icon: "4Ô∏è‚É£" },
            { en: "Five", zh: "5", speak: "Five", icon: "5Ô∏è‚É£" },
            { en: "Six", zh: "6", speak: "Six", icon: "6Ô∏è‚É£" },
            { en: "Seven", zh: "7", speak: "Seven", icon: "7Ô∏è‚É£" },
            { en: "Eight", zh: "8", speak: "Eight", icon: "8Ô∏è‚É£" },
            { en: "Nine", zh: "9", speak: "Nine", icon: "9Ô∏è‚É£" },
            { en: "Ten", zh: "10", speak: "Ten", icon: "üîü" }
        ],
        "üé® È°èËâ≤ Colors": [
            { en: "Red", zh: "Á¥ÖËâ≤", icon: "üü•" },
            { en: "Blue", zh: "ËóçËâ≤", icon: "üü¶" },
            { en: "Yellow", zh: "ÈªÉËâ≤", icon: "üü®" },
            { en: "Green", zh: "Á∂†Ëâ≤", icon: "üü©" },
            { en: "Orange", zh: "Ê©òËâ≤", icon: "üüß" },
            { en: "Purple", zh: "Á¥´Ëâ≤", icon: "üü™" },
            { en: "Pink", zh: "Á≤âÁ¥ÖËâ≤", icon: "üå∏" },
            { en: "Black", zh: "ÈªëËâ≤", icon: "‚¨õ" },
            { en: "White", zh: "ÁôΩËâ≤", icon: "‚¨ú" }
        ]
    };

    // ==========================================
    //  2. State
    // ==========================================
    let currentRoom = Object.keys(db)[0];
    let isQuiz = false;
    let quizTarget = null;
    let currentItem = null;
    let imgCache = {};
    let isFocusMode = false;
    let focusIndex = 0;
    let activeItems = []; 
    let mediaRecorder = null; 
    let globalStream = null; // **Fix: Reuse stream**

    let displayMode = 0;
    const modeConfigs = [
        { text: "üìñ È°ØÁ§∫Ôºö‰∏≠+Ëã±", showEn: true, showZh: true },
        { text: "üî§ È°ØÁ§∫ÔºöËã±Êñá", showEn: true, showZh: false },
        { text: "üà∑Ô∏è È°ØÁ§∫Ôºö‰∏≠Êñá", showEn: false, showZh: true },
        { text: "üñºÔ∏è È°ØÁ§∫ÔºöÂè™ÊúâÂúñ", showEn: false, showZh: false }
    ];

    function init() {
        renderNav();
        loadRoom(currentRoom);
    }

    function renderNav() {
        const nav = document.getElementById('navBar');
        nav.innerHTML = '';
        Object.keys(db).forEach(room => {
            const btn = document.createElement('span');
            const isPhonics = room.includes("üî§");
            const displayName = room.includes(" ") ? room.split(" ")[1] : room;
            btn.className = `room-tab ${room === currentRoom ? 'active' : ''} ${isPhonics ? 'phonics-tab' : ''}`;
            btn.innerText = displayName;
            btn.onclick = () => {
                document.getElementById('searchInput').value = "";
                loadRoom(room);
            };
            nav.appendChild(btn);
        });
    }

    function loadRoom(room) {
        currentRoom = room;
        activeItems = db[room];
        renderGrid();
        renderNav();
        if(isQuiz) nextQuestion();
        if(isFocusMode) {
            focusIndex = 0;
            renderFocusCard();
        }
    }

    function handleSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        if(!query) {
            loadRoom(currentRoom);
            return;
        }
        let results = [];
        Object.keys(db).forEach(key => {
            db[key].forEach(item => {
                if(item.en.toLowerCase().includes(query) || item.zh.includes(query)) {
                    results.push(item);
                }
            });
        });
        activeItems = results;
        renderGrid();
        if(isFocusMode) {
            focusIndex = 0;
            renderFocusCard();
        }
    }

    function cycleMode() {
        displayMode = (displayMode + 1) % 4;
        updateModeUI();
    }

    function updateModeUI() {
        const config = modeConfigs[displayMode];
        document.getElementById('btnMode').innerText = config.text;
        renderGrid();
        if(isFocusMode) renderFocusCard();
    }

    // --- Render Grid ---
    function renderGrid() {
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = '';
        const isWorldMap = currentRoom.includes("World") && document.getElementById('searchInput').value === "";
        const isPhonics = currentRoom.includes("üî§");
        const config = modeConfigs[displayMode];

        grid.classList.remove('hide-zh', 'hide-en', 'hide-text');
        if (!config.showZh) grid.classList.add('hide-zh');
        if (!config.showEn) grid.classList.add('hide-en');
        if (!config.showZh && !config.showEn) grid.classList.add('hide-text'); 

        activeItems.forEach((item, index) => {
            const card = document.createElement('div');
            let classes = ['card'];
            if(item.speak) classes.push('phonics-card');
            if(isWorldMap && item.code) classes.push('flag-card');
            card.className = classes.join(' ');
            
            let bgColor = "#f0f0f0";
            if (item.rule) bgColor = stringToPastelColor(item.rule); 
            else bgColor = stringToColor(item.en);

            let visualContent = "";
            let topLabel = "";

            if (isPhonics && item.rule) {
                topLabel = `<div class="rule-tag" style="background:${stringToDarkerColor(item.rule)}">${item.rule}</div>`;
                visualContent = `<div class="card-img" style="background:${bgColor}">${item.icon}</div>`;
            } else if (isWorldMap && item.code) {
                visualContent = `<div class="card-img"><img src="https://flagcdn.com/h240/${item.code}.png" alt="${item.en}"></div>`;
            } else {
                visualContent = `<div class="card-img" style="background:${bgColor};opacity:0.8">${item.icon}</div>`;
            }
            
            card.innerHTML = `
                ${topLabel}
                ${visualContent}
                <div class="card-body">
                    <span class="en-word">${item.en}</span>
                    <span class="zh-word">${item.zh}</span>
                </div>
            `;
            
            card.onclick = (e) => handleClick(item, card, index);
            grid.appendChild(card);
        });
        
        if(activeItems.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px;">Êâæ‰∏çÂà∞ÈÄôÂÄãÂñÆÂ≠óÂñî...</div>';
        }
    }

    // --- Audio Stream Helper (Fix for permission) ---
    async function getAudioStream() {
        // If stream exists and is active, reuse it
        if (globalStream && globalStream.active) return globalStream;
        
        try {
            // Request permission once
            globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            return globalStream;
        } catch (err) {
            console.error(err);
            alert("ÁÑ°Ê≥ïÂ≠òÂèñÈ∫•ÂÖãÈ¢®ÔºåË´ãÊ™¢Êü•Ê¨äÈôêÊàñ‰ΩøÁî® HTTPS ÈÄ£Á∑ö„ÄÇ");
            return null;
        }
    }

    // --- Record Logic ---
    async function toggleRecord(event, btn) {
        event.stopPropagation(); 

        // 1. Get Stream (Reused)
        const stream = await getAudioStream();
        if(!stream) return;

        const container = btn.parentElement;
        if (container.classList.contains('recording')) return;

        try {
            mediaRecorder = new MediaRecorder(stream);
            const audioChunks = [];

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play(); 
                container.classList.remove('recording');
                // Note: We do NOT stop tracks here to keep permission alive
            };

            mediaRecorder.start();
            container.classList.add('recording'); 

            setTimeout(() => {
                if (mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                }
            }, 2000); 

        } catch (err) {
            console.error("Recorder Error:", err);
        }
    }

    function handleClick(item, cardElem, index) {
        if (!isQuiz) {
            const text = item.speak ? item.speak : item.en;
            speak(text);
            
            if(cardElem) {
                cardElem.style.transform = "scale(1.05)";
                setTimeout(() => cardElem.style.transform = "", 200);
            }

            const isPhonicsCategory = currentRoom.includes("üî§");
            if (!isPhonicsCategory && !isFocusMode) {
                currentItem = item;
                openImageModal(item);
            }
        } else {
            if (item.en === quizTarget.en) {
                if(cardElem) cardElem.classList.add('correct');
                if(isFocusMode) {
                    document.getElementById('focusCard').style.borderColor = "#4CAF50";
                    document.getElementById('focusCard').style.background = "#E8F5E9";
                }
                speak("Great job!");
                setTimeout(() => {
                    if(cardElem) cardElem.classList.remove('correct');
                    if(isFocusMode) {
                        const fc = document.getElementById('focusCard');
                        fc.style.borderColor = "white";
                        fc.style.background = "white";
                    }
                    nextQuestion();
                }, 1500);
            } else {
                if(cardElem) cardElem.classList.add('wrong');
                if(isFocusMode) {
                    const fc = document.getElementById('focusCard');
                    fc.style.borderColor = "#F44336";
                    setTimeout(() => fc.style.borderColor = "white", 500);
                }
                speak("Try again!");
                setTimeout(() => { if(cardElem) cardElem.classList.remove('wrong'); }, 500);
            }
        }
    }

    function toggleFocusMode() {
        isFocusMode = !isFocusMode;
        const overlay = document.getElementById('focusOverlay');
        const btn = document.getElementById('btnFocus');
        if(isFocusMode) {
            overlay.style.display = 'flex';
            btn.classList.add('active');
            focusIndex = 0;
            renderFocusCard();
        } else {
            overlay.style.display = 'none';
            btn.classList.remove('active');
        }
    }

    function focusNav(dir) {
        focusIndex += dir;
        if(focusIndex < 0) focusIndex = activeItems.length - 1;
        if(focusIndex >= activeItems.length) focusIndex = 0;
        renderFocusCard();
    }
    
    function renderFocusCard() {
        if(activeItems.length === 0) return;
        const item = activeItems[focusIndex];
        const container = document.getElementById('focusContent');
        const ruleDisplay = document.getElementById('focusRule');
        const bgLayer = document.getElementById('focusBg');
        const micContainer = document.getElementById('focusMicContainer');
        const isWorldMap = currentRoom.includes("World") && !document.getElementById('searchInput').value;
        const config = modeConfigs[displayMode];
        
        let bgColor = item.rule ? stringToPastelColor(item.rule) : stringToColor(item.en);
        bgLayer.style.background = item.rule ? bgColor : `#${bgColor}`;
        bgLayer.style.opacity = item.rule ? "0.3" : "0.1";

        ruleDisplay.innerText = item.rule ? item.rule : "";
        ruleDisplay.style.color = stringToDarkerColor(item.rule || item.en);

        let visual = `<div class="focus-icon">${item.icon}</div>`;
        if(isWorldMap && item.code) {
            visual = `<img src="https://flagcdn.com/h240/${item.code}.png" class="focus-flag-img">`;
        }

        let enStyle = config.showEn ? '' : 'opacity:0';
        let zhStyle = config.showZh ? '' : 'opacity:0';

        container.innerHTML = `
            ${visual}
            <div class="focus-en" style="${enStyle}">${item.en}</div>
            <div class="focus-zh" style="${zhStyle}">${item.zh}</div>
            <div style="margin-top:20px;color:#999;font-size:0.9rem;">${focusIndex + 1} / ${activeItems.length}</div>
        `;

        if(isQuiz) {
            micContainer.style.display = 'none';
        } else {
            micContainer.style.display = 'flex';
            setTimeout(() => {
                const text = item.speak ? item.speak : item.en;
                speak(text);
            }, 300);
        }
    }

    function handleFocusClick() {
        if(activeItems.length > 0) {
            handleClick(activeItems[focusIndex], null, focusIndex);
        }
    }

    async function openImageModal(item, forceRandom = false) {
        const modal = document.getElementById('imgModal');
        const realImg = document.getElementById('realImage');
        const loader = document.getElementById('modalLoader');
        const sourceTag = document.getElementById('imgSource');
        const enText = document.getElementById('modalEn');
        const zhText = document.getElementById('modalZh');

        modal.style.display = 'flex';
        enText.innerText = item.en;
        zhText.innerText = item.zh;
        
        realImg.style.display = 'none';
        loader.style.display = 'block';
        sourceTag.style.display = 'none';

        if (forceRandom) { loadRandomImage(item.en); return; }
        if (imgCache[item.en]) { showImg(imgCache[item.en], 'Wiki (Cached)'); return; }

        try {
            const keyword = item.en.split(" ")[0].trim().replace(/ /g, "_");
            const wikiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${keyword}`;
            const response = await fetch(wikiUrl);
            if (!response.ok) throw new Error("Wiki Not Found");
            const data = await response.json();
            if (data.thumbnail && data.thumbnail.source) {
                const imgSrc = data.thumbnail.source;
                imgCache[item.en] = imgSrc; 
                showImg(imgSrc, 'Wiki');
            } else {
                throw new Error("No Wiki Image");
            }
        } catch (error) {
            loadRandomImage(item.en);
        }
    }

    function loadRandomImage(keywordRaw) {
        const realImg = document.getElementById('realImage');
        const loader = document.getElementById('modalLoader');
        loader.innerText = "üîç ÊêúÂ∞ãÁ∂≤Ë∑ØÁæéÂúñ...";
        let keyword = keywordRaw.split(" ")[0].toLowerCase();
        let searchPath = keyword;
        if (currentRoom.includes("World") || currentRoom.includes("Âú∞Âúñ")) {
             searchPath = `${keyword},landscape,landmark/all`;
        }
        const randomLock = Math.floor(Math.random() * 10000);
        const imgUrl = `https://loremflickr.com/500/400/${searchPath}?lock=${randomLock}`;
        const tempImg = new Image();
        tempImg.src = imgUrl;
        tempImg.onload = () => showImg(imgUrl, 'Web');
        tempImg.onerror = () => { loader.innerText = "‚ùå Êâæ‰∏çÂà∞ÂúñÁâá"; };
    }

    function showImg(url, source) {
        const realImg = document.getElementById('realImage');
        const loader = document.getElementById('modalLoader');
        const sourceTag = document.getElementById('imgSource');
        realImg.src = url;
        loader.style.display = 'none';
        realImg.style.display = 'block';
        sourceTag.innerText = source;
        sourceTag.style.display = 'block';
        sourceTag.style.background = source.includes('Wiki') ? 'rgba(0,0,0,0.6)' : 'rgba(255,165,0,0.8)';
    }

    function handleFallback() { if(currentItem) loadRandomImage(currentItem.en); }
    function forceRandomReload() { if(currentItem) openImageModal(currentItem, true); }
    function closeModal() { document.getElementById('imgModal').style.display = 'none'; }

    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
        return "00000".substring(0, 6 - c.length) + c;
    }
    function stringToPastelColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const hue = hash % 360;
        return `hsl(${hue}, 70%, 90%)`; 
    }
    function stringToDarkerColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const hue = hash % 360;
        return `hsl(${hue}, 60%, 40%)`; 
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.85; 
        window.speechSynthesis.speak(u);
    }

    function toggleQuiz() {
        isQuiz = !isQuiz;
        const area = document.getElementById('quizArea');
        const btn = document.querySelector('.btn-quiz');
        if (isQuiz) {
            area.style.display = 'block';
            btn.innerText = "üìö ÂõûÂà∞Â≠∏Áøí";
            btn.style.background = "#FF6B6B";
            nextQuestion();
        } else {
            area.style.display = 'none';
            btn.innerText = "üéÆ Ê∏¨È©ó";
            btn.style.background = "var(--primary)";
        }
        if(isFocusMode) renderFocusCard();
    }

    function nextQuestion() {
        if (!activeItems || activeItems.length === 0) return;
        let newItem;
        do {
            newItem = activeItems[Math.floor(Math.random() * activeItems.length)];
        } while (activeItems.length > 1 && quizTarget && newItem.en === quizTarget.en);
        
        quizTarget = newItem;
        const qText = document.getElementById('quizQuestion');
        
        if (currentRoom.includes("üî§")) {
             qText.innerText = `üëÇ Âì™ÂÄãÊòØ "${quizTarget.en}" ?`;
             const hint = quizTarget.speak ? quizTarget.speak : quizTarget.en;
             speak(`Find ${hint}`);
        } else {
             qText.innerText = `üëÇ Find: "${quizTarget.en}"`;
             speak(`Where is the ${quizTarget.en}?`);
        }
    }

    init();

</script>
</body>
</html>
